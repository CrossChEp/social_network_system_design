# System design социальный сети для курса по system design

## Функциональные требования

- Создание поста с описанием
- Указание локации в посте
- Прикрепление одной или нескольких фотографий к посту
- Оценивание и комментирование постов другими пользователями
- Подписка на других пользователей для отслеживания новостей
- Поиск популярных локаций
- Поиск постов с определенными локациями
- Просмотр ленты других путешественников и ленты пользователя, 
основанной на подписках в обратном хронологическом порядке
- Пользователь может просматривать кол-во лайков на посте

## Нефункциональные требования

- DAU = 10 000 000
- Аудитория стран СНГ
- Данные хранятся всегда
- Активность пользователей
  - В среднем каждый пользователь создает 5 постов в месяц
  - В среднем каждый пользователь просматривает 30 постов в день
  - В среднем каждый пользователь лайкает 15 постов в день
  - В среднем каждый пользователь читает 20 комментариев в день
  - В среднем каждый пользователь комментирует 5 постов в день
  - В среднем каждый пользователь ищет 10 постов в день
- Лимиты
  - Максимальное кол-во изображений, которое может добавить пользователь к посту - 10
  - Максимальный размер изображения - 500КБ
  - За один запрос пользователь получает 5 постов
  - За один запрос пользователь получает 5 комментариев
- Сезонность:
  - Нагрузка будет повышаться в сезон отпусков(летом и зимой) примерно на 30%
- Доступность системы
  - SLA: 99.90

## Расчет нагрузки

### Посты

**RPS**
```
Read = 10 000 000 * 6 / 86400 = 700
Write = 10 000 000 * 5 / 30 / 24 / 60 / 60 = 20
```

**Трафик**

**Модель данных**

| post        |
|-------------|
| post_id     |
| content     |
| author_id   |
| location_id |
| created_at  |

| attachment |
|------------|
| post_id    |
| object_url |


**Нагрузка(по сущности)**
```
Read = 240Б * 700 * 5 / 1000 = 840КБ/C
Write =  240Б * 20 / 1000 = 4КБ/С
```

**Расчет ресурсов(по сущности)**
```
Capacity = 4КБ/С * 86400 * 365 / 1000 / 1000 = 126ГБ
HDD:
  disks_for_iops = 720 / 100 = 8 дисков
  disks_for_throughput = 844КБ/С / 100МБ/С = 1 диск
  disks_for_capcity = 126 / 500ГБ = 1 диск
  disks = 8 дисков по 500ГБ
```

**Распределенные данные**
```
PgSQL:
- async replication, RF 2, master-slave
- 2 диска на 1 хост = 4 шарда * 2 = 8 хостов по 2 диска
- key-base way by author_id
```

**Нагрузка(по медиаданным)**
Если брать максимальный размер изображения и максимальное кол-во
изображений в посте(10), то получаются такие расчеты:
```
Read = 500KB * 700 * 5 * 10 = 18ГБ/С
Write = 500KB * 20 * 10 = 100МБ/С
```

**Расчет ресурсов(по медиаданным)**
```
Capacity = 100МБ/С * 86400 * 365 / 1000 / 1000 / 1000 = 3ПТБ
SSD(SATA):
  disks_for_iops = 720 / 1000 = 1 диск
  disks_for_throughput = 18100МБ/С / 500 = 37 дисков
  disks_for_capcity = 3000ТБ /30ТБ  = 100 дисков
  disks = 100 дисков по 30ТБ
```

### Лайки

**RPS**
```
Read(получаем только кол-во лайков на посте) = 10 000 000 * 6 / 86400 = 700
Write = 10 000 000 * 15 / 86400 = 1700
```

**Трафик**

**Модель данных**

| like       |
|------------|
| post_id    |
| liker_id   |

**Нагрузка**
```
Read = 16Б * 700 * 5 = 56КБ/C
Write = 16Б * 1700 / 1000 = 27КБ/С
```

**Расчет ресурсов**
```
Capacity = 56КБ/С * 86400 * 365 / 1000 / 1000 / 1000 = 2ТБ
HDD:
  disks_for_iops = 2400 / 100 = 24 диска
  disks_for_throughput = 83КБ/С / 100МБ/С = 1 диск
  disks_for_capcity = 2ТБ / 500 ГБ = 4 диска
  disks = 24 диска по 500ГБ
  
SSD:
  disks_for_iops = 2400 / 1000 = 3 диска
  disks_for_throughput = 83КБ/С / 500МБ/С = 1 диск
  disks_for_capcity = 2ТБ / 500 ГБ = 4 диска
  disks = 4 диска по 500ГБ
```

**Распределенные данные**
```
PgSQL:
- async replication, RF 2, master-slave
HDD:
  - 2 диска на 1 хост = 12 шардов * 2 = 24 хоста по 2 диска
- key-base way by post_id
```

### Комментарии

**RPS**
```
Read = 10 000 000 * 20 / 5 / 86400 = 460
Write = 10 000 000 * 5 / 86400 = 580
```

**Трафик**

**Модель данных**

| comment    |
|------------|
| comment_id |
| post_id    |
| author_id  |
| content    |
| created_at |

**Нагрузка**
```
Read = 132Б * 5 * 460 / 1000 = 300КБ/С
Write = 132Б * 580 / 1000 = 76КБ/С
```

```
Capacity = 76КБ/С * 86400 * 365 / 1000 / 1000 / 1000 = 3ТБ
HDD:
  disks_for_iops = 1000 / 100 = 10 дисков
  disks_for_throughput = 376КБ/С / 100МБ/С = 1 диск
  disks_for_capcity = 3ТБ / 500 ГБ = 6 дисков
  disks = 10 дисков по 500 ГБ
```

**Распределенные данные**
```
PgSQL:
- async replication, RF 2, master-slave
- 2 диска на 1 хост = 5 шардов * 2 = 10 хостов по 2 диска
- key-base way by post_id
```